<powershell>

#Disable firewall
netsh advfirewall set allprofiles state off

#Install python
$python_version = "3.11.6"
Invoke-WebRequest "https://www.python.org/ftp/python/$python_version/python-${python_version}-amd64.exe" -OutFile C:\Windows\Temp\python.exe -UseBasicParsing
Start-Process C:\Windows\Temp\python.exe -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1" -NoNewWindow -Wait
$env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")

#Install nginx
$nginx_version = "nginx-1.25.3"
Invoke-WebRequest "https://nginx.org/download/${nginx_version}.zip" -OutFile C:\Windows\Temp\nginx.zip -UseBasicParsing
Expand-Archive C:\Windows\Temp\nginx.zip C:\Windows\Temp -Force
Copy-Item "C:\Windows\Temp\$nginx_version" C:\nginx -Recurse -Force

#Download repo
Invoke-WebRequest https://github.com/shyguyCreate/ec2-flask/archive/refs/heads/main.zip -OutFile C:\Windows\Temp\repo.zip -UseBasicParsing
Expand-Archive C:\Windows\Temp\repo.zip C:\Windows\Temp

#Copy python app to user directory
Copy-Item C:\Windows\Temp\ec2-flask-main\app C:\ -Recurse -Force

#Create and activate virtual environment
python -m venv C:\app\.venv
& C:\app\.venv\Scripts\Activate.ps1

#Install program dependencies
pip install -r "C:\app\requirements.txt"

#Create flask service to start automatically
New-Service `
    -Name "Flask-App" `
    -BinaryPathName '"C:\app\.venv\Scripts\python.exe C:\app\app.py"' `
    -DisplayName "Flask App" `
    -Description "Flask service with Waitress for web app" `
    -StartupType "AutomaticDelayedStart"

#Start flask service
Start-Service -Name "Flask-App"

#Set nginx config
Copy-Item C:\Windows\Temp\ec2-flask-main\nginx.conf C:\nginx\conf\default.conf -Force

#Add include conf file in main nginx.conf
Get-Content C:\nginx\conf\nginx.conf |
    ForEach-Object {
        if ($_ -cmatch "^\s+server\s?\{") {
            Write-Output "    include  default.conf;`n"
        }
        Write-Output $_
    } | Set-Content C:\nginx\conf\nginx.conf

#Create nginx service to start automatically
New-Service `
    -Name "Nginx-Flask" `
    -BinaryPathName '"C:\nginx\nginx.exe"' `
    -DisplayName "Nginx Flask" `
    -Description "Nginx service to port forward to Flask app" `
    -StartupType "AutomaticDelayedStart"

#Start nginx service
Start-Service -Name "Nginx-Flask"

</powershell>
