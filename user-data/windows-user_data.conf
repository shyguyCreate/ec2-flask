<powershell>

#Disable firewall
netsh advfirewall set allprofiles state off

#Set directory of default EC2 user
$user_dir = "C:\Users\Administrator"

#Install python
$python_version = "3.11.6"
Invoke-WebRequest "https://www.python.org/ftp/python/$python_version/python-${python_version}-amd64.exe" -OutFile "$user_dir\python.exe" -UseBasicParsing
Set-Location "$user_dir"
Start-Process .\python.exe -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1" -NoNewWindow -Wait
$env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")

#Install nginx
$nginx_version = "nginx-1.25.3"
Invoke-WebRequest "https://nginx.org/download/${nginx_version}.zip" -OutFile C:\Windows\Temp\nginx.zip -UseBasicParsing
Expand-Archive C:\Windows\Temp\nginx.zip C:\Windows\Temp -Force
Copy-Item "C:\Windows\Temp\$nginx_version" C:\nginx -Recurse -Force

#Download repo
Invoke-WebRequest https://github.com/shyguyCreate/ec2-flask/archive/refs/heads/main.zip -OutFile C:\Windows\Temp\repo.zip -UseBasicParsing
Expand-Archive C:\Windows\Temp\repo.zip C:\Windows\Temp

#Copy python app to user directory
Copy-Item C:\Windows\Temp\ec2-flask-main\app "$user_dir" -Recurse -Force

#Create and activate virtual environment
python3 -m venv "$user_dir\app\.venv"
& "$user_dir\app\.venv\Scripts\Activate.ps1"

#Install program dependencies
pip install -r "$user_dir\app\requirements.txt"

#Start nginx
Set-Location C:\nginx
Start-Process .\nginx.exe

</powershell>
